/*
 * Copyright 2015-2022 Adrià Giménez Pastor.
 *
 * This file is part of adriagipas/memus.
 *
 * adriagipas/memus is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * adriagipas/memus is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with adriagipas/memus.  If not, see <https://www.gnu.org/licenses/>.
 */
/*
 *  tiles.c - Implementació de 'tiles16b.h'.
 *
 */


#include <stddef.h>
#include <stdlib.h>

#include "tiles16b.h"




/*************/
/* CONSTANTS */
/*************/

static const unsigned short TILES[51][16]=
{
  {0x0A90,0x29A4,0xA569,0xA429,0xA429,0xA429,0xAAA9,0xA569,  /* 0 : A */
   0xA429,0xA429,0xA429,0x5415,0x0000,0x0000,0x0000,0x0000},
  {0xAAA4,0xA569,0xA429,0xA429,0xA429,0xAAA5,0xA569,0xA429,
   0xA429,0xA429,0xAAA5,0x5554,0x0000,0x0000,0x0000,0x0000},
  {0x0AA4,0x2969,0xA515,0xA400,0xA400,0xA400,0xA400,0xA400,
   0xA400,0x6929,0x1AA5,0x0554,0x0000,0x0000,0x0000,0x0000},
  {0xAA90,0xA5A4,0xA469,0xA429,0xA429,0xA429,0xA429,0xA429,
   0xA429,0xA4A5,0xAA94,0x5550,0x0000,0x0000,0x0000,0x0000},
  {0xAAA9,0xA555,0xA400,0xA400,0xA400,0xAA90,0xA550,0xA400,
   0xA400,0xA400,0xAAA9,0x5555,0x0000,0x0000,0x0000,0x0000},
  {0xAAA9,0xA555,0xA400,0xA400,0xA400,0xAA90,0xA550,0xA400,
   0xA400,0xA400,0xA400,0x5400,0x0000,0x0000,0x0000,0x0000},
  {0x0AA4,0x2969,0xA515,0xA400,0xA400,0xA400,0xA4A9,0xA469,
   0xA429,0x6929,0x1AA9,0x0555,0x0000,0x0000,0x0000,0x0000},
  {0xA429,0xA429,0xA429,0xA429,0xA429,0xAAA9,0xA569,0xA429,
   0xA429,0xA429,0xA429,0x5415,0x0000,0x0000,0x0000,0x0000},
  {0x0AA4,0x0694,0x0290,0x0290,0x0290,0x0290,0x0290,0x0290,
   0x0290,0x0290,0x0AA4,0x0554,0x0000,0x0000,0x0000,0x0000},
  {0x0029,0x0029,0x0029,0x0029,0x0029,0x0029,0x0029,0x0029,
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0xA409,0xA429,0xA4A5,0xA694,0xAA50,0xA940,0xAA40,0xAA90,
   0xA6A4,0xA5A9,0xA469,0x5415,0x0000,0x0000,0x0000,0x0000},
  {0xA400,0xA400,0xA400,0xA400,0xA400,0xA400,0xA400,0xA400,
   0xA400,0xA400,0xAAA9,0x5555,0x0000,0x0000,0x0000,0x0000},
  {0x9009,0xA429,0xA9A9,0xAAA9,0xAAA9,0xA669,0xA569,0xA429,
   0xA429,0xA429,0xA429,0x5415,0x0000,0x0000,0x0000,0x0000},
  {0xA429,0xA929,0xA929,0xAA69,0xAA69,0xA6A9,0xA6A9,0xA5A9,
   0xA4A9,0xA469,0xA429,0x5415,0x0000,0x0000,0x0000,0x0000},
  {0x2AA4,0xA569,0xA429,0xA429,0xA429,0xA429,0xA429,0xA429,
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0xAAA4,0xA569,0xA429,0xA429,0xA429,0xA429,0xAAA5,0xA554,
   0xA400,0xA400,0xA400,0x5400,0x0000,0x0000,0x0000,0x0000},
  {0x2AA4,0xA569,0xA429,0xA429,0xA429,0xA429,0xA429,0xAA69,
   0xA5A9,0xA4A5,0x6A69,0x1555,0x0000,0x0000,0x0000,0x0000},
  {0xAAA4,0xA569,0xA429,0xA429,0xA429,0xA429,0xAAA5,0xA694,
   0xA5A4,0xA469,0xA429,0x5415,0x0000,0x0000,0x0000,0x0000},
  {0x2A90,0xA5A4,0xA454,0xA400,0x6900,0x1A90,0x05A4,0x0069,
   0x0029,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x2AA9,0x1695,0x0290,0x0290,0x0290,0x0290,0x0290,0x0290,
   0x0290,0x0290,0x0290,0x0150,0x0000,0x0000,0x0000,0x0000},
  {0xA429,0xA429,0xA429,0xA429,0xA429,0xA429,0xA429,0xA429,
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0xA429,0xA429,0xA429,0xA429,0xA429,0x69A5,0x29A4,0x1A94,
   0x0A90,0x0650,0x0240,0x0140,0x0000,0x0000,0x0000,0x0000},
  {0xA429,0xA429,0xA429,0xA429,0xA429,0xA429,0xA669,0xAAA9,
   0xAAA9,0x69A5,0x2564,0x1414,0x0000,0x0000,0x0000,0x0000},
  {0xA429,0xA429,0x69A5,0x29A4,0x1A94,0x0A90,0x0A90,0x29A4,
   0x29A4,0xA569,0xA429,0x5415,0x0000,0x0000,0x0000,0x0000},
  {0x2929,0x2929,0x2929,0x2929,0x2929,0x1AA5,0x0694,0x0290,
   0x0290,0x0290,0x0290,0x0150,0x0000,0x0000,0x0000,0x0000},
  {0xAAA9,0x55A9,0x00A5,0x02A4,0x0294,0x0A90,0x0A50,0x2A40,   /* 25 : Z */
   0x2940,0xA900,0xAAA9,0x5555,0x0000,0x0000,0x0000,0x0000},  
  {0x2AA4,0xA569,0xA429,0xA429,0xA429,0xA429,0xA429,0xA429,   /* 26 : 0 */
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x0290,0x0A90,0x0690,0x0290,0x0290,0x0290,0x0290,0x0290,
   0x0290,0x0290,0x0290,0x0150,0x0000,0x0000,0x0000,0x0000},
  {0x2AA4,0xA569,0xA429,0x5429,0x00A5,0x00A4,0x0294,0x0A50,
   0x2940,0xA500,0xAAA9,0x5555,0x0000,0x0000,0x0000,0x0000},
  {0x2AA4,0xA569,0xA429,0x5429,0x0029,0x02A5,0x0169,0x0029,
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x02A4,0x02A4,0x09A4,0x09A4,0x25A4,0x24A4,0x94A4,0xAAA9,
   0x55A5,0x00A4,0x00A4,0x0054,0x0000,0x0000,0x0000,0x0000},
  {0xAAA4,0xA554,0xA400,0xA400,0xAAA4,0xA569,0x5429,0x0029,
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x2AA4,0xA569,0xA429,0xA415,0xAAA4,0xA569,0xA429,0xA429,
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0xAAA9,0x5569,0x0029,0x00A5,0x0294,0x0290,0x0A50,0x0A40,
   0x2940,0x2900,0x2900,0x1500,0x0000,0x0000,0x0000,0x0000},
  {0x2AA4,0xA569,0xA429,0xA429,0xA429,0x6AA5,0xA569,0xA429,
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x2AA4,0xA569,0xA429,0xA429,0xA429,0xA429,0x6AA9,0x1569,    /* 35 : 9 */
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x0AA4,0x2969,0xA515,0xA400,0xA400,0xA400,0xA400,0xA400,    /* 36 : Ç */
   0xA400,0x6929,0x1AA5,0x0694,0x0190,0x0A90,0x0540,0x0000},
  {0x0A40,0x0690,0x0150,0x0000,0x2AA4,0x1569,0x0029,0x2AA9,    /* 37 : à */
   0xA569,0xA429,0x6AA9,0x1555,0x0000,0x0000,0x0000,0x0000},
  {0x0A40,0x0690,0x0150,0x0000,0x2AA4,0xA569,0xA429,0xAAA9,    /* 38 : è */
   0xA555,0xA400,0x6AA4,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x0290,0x0A50,0x0540,0x0000,0x2AA4,0xA569,0xA429,0xAAA9,    /* 39 : é */
   0xA555,0xA400,0x6AA4,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x00A4,0x0294,0x0150,0x0000,0x0290,0x0290,0x0290,0x0290,    /* 40 : í */
   0x0290,0x0290,0x0290,0x0150,0x0000,0x0000,0x0000,0x0000},
  {0x0A40,0x0690,0x0150,0x0000,0x2AA4,0xA569,0xA429,0xA429,    /* 41 : ò */
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x0290,0x0A50,0x0540,0x0000,0x2AA4,0xA569,0xA429,0xA429,    /* 42 : ó */
   0xA429,0xA429,0x6AA5,0x1554,0x0000,0x0000,0x0000,0x0000},
  {0x0290,0x0A50,0x0540,0x0000,0xA429,0xA429,0xA429,0xA429,    /* 43 : ú */
   0xA429,0xA429,0x6AA9,0x1555,0x0000,0x0000,0x0000,0x0000},
  {0x0000,0x0000,0x0290,0x0290,0x0150,0x0000,0x0000,0x0290,    /* 44 : : */
   0x0290,0x0150,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
  {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    /* 45 : . */
   0x0000,0x0290,0x0290,0x0150,0x0000,0x0000,0x0000,0x0000},
  {0x0000,0x00A4,0x00A4,0x0294,0x0290,0x0A50,0x0A40,0x2940,    /* 46 : / */
   0x2900,0xA500,0xA400,0x5400,0x0000,0x0000,0x0000,0x0000},
  {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    /* 47 : blanc */
   0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
  {0x0000,0x0000,0x0000,0x0000,0x0000,0x2AA9,0x2AA9,0x1555,
   0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},   /* 48 : - */
  {0x0000,0x0000,0x0000,0x0290,0x0290,0x2AA9,0x2AA9,0x1695,
   0x0290,0x0150,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},   /* 49 : + */
  {0x0290,0x0290,0x0290,0x0290,0x0290,0x0290,0x0290,0x0150,
   0x0000,0x0290,0x0290,0x0150,0x0000,0x0000,0x0000,0x0000}    /* 50 : ! */
};




/*********/
/* ESTAT */
/*********/

/* char -> tile índex. */
static unsigned char _char2tile[256];




/*********************/
/* FUNCIONS PRIVADES */
/*********************/

static void
draw_tile (
           int       *fb,
           const int  fb_width,
           const int  tile,
           const int  x,
           const int  y,
           const int  fgcolor1,
           const int  fgcolor2,
           const int  bgcolor,
           const int  flags
           )
{
  
  int offset, r, c;
  const unsigned short *pat;
  unsigned short word;
  
  
  pat= TILES[tile];
  offset= !(flags&T16_XY_IN_PIXELS) ? (y*16*fb_width + x*8) : (y*fb_width + x);
  for ( r= 0; r < 16; ++r )
    {
      word= pat[r];
      for ( c= 0; c < 8; ++c )
        {
          switch ( (word&0xC000)>>14 )
            {
            case 0: if ( !(flags&T16_BG_TRANS)) fb[offset+c]= bgcolor; break;
            case 1: if ( !(flags&T16_FG1_TRANS) ) fb[offset+c]= fgcolor1; break;
            case 2: if ( !(flags&T16_FG2_TRANS) ) fb[offset+c]= fgcolor2; break;
            default: break;
            }
          word<<= 2;
        }
      offset+= fb_width;
    }
  
} /* end draw_tile */


static void
draw_tile_s (
             short       *fb,
             const int    fb_width,
             const int    tile,
             const int    x,
             const int    y,
             const short  fgcolor1,
             const short  fgcolor2,
             const short  bgcolor,
             const int    flags
             )
{
  
  int offset, r, c;
  const unsigned short *pat;
  unsigned short word;
  
  
  pat= TILES[tile];
  offset= !(flags&T16_XY_IN_PIXELS) ? (y*16*fb_width + x*8) : (y*fb_width + x);
  for ( r= 0; r < 16; ++r )
    {
      word= pat[r];
      for ( c= 0; c < 8; ++c )
        {
          switch ( (word&0xC000)>>14 )
            {
            case 0: if ( !(flags&T16_BG_TRANS)) fb[offset+c]= bgcolor; break;
            case 1: if ( !(flags&T16_FG1_TRANS) ) fb[offset+c]= fgcolor1; break;
            case 2: if ( !(flags&T16_FG2_TRANS) ) fb[offset+c]= fgcolor2; break;
            default: break;
            }
          word<<= 2;
        }
      offset+= fb_width;
    }
  
} /* end draw_tile_s */




/**********************/
/* FUNCIONS PÚBLIQUES */
/**********************/

void
tiles16b_draw_string (
        	      int        *fb,
        	      const int   fb_width,
        	      const char *string,
        	      int         x,
        	      const int   y,
        	      const int   fgcolor1,
        	      const int   fgcolor2,
        	      const int   bgcolor,
        	      const int   flags
        	      )
{
  
  const char *p;
  int inc;
  

  inc= flags&T16_XY_IN_PIXELS ? 8 : 1;
  for ( p= string; *p; ++p, x+= inc )
    draw_tile ( fb, fb_width, _char2tile[(unsigned char) *p],
        	x, y, fgcolor1, fgcolor2, bgcolor, flags );
  
} /* end tiles16b_draw_string */


void
tiles16b_draw_string_s (
        		short       *fb,
        		const int    fb_width,
        		const char  *string,
        		int          x,
        		const int    y,
        		const short  fgcolor1,
        		const short  fgcolor2,
        		const short  bgcolor,
        		const int    flags
        		)
{
  
  const char *p;
  int inc;
  

  inc= flags&T16_XY_IN_PIXELS ? 8 : 1;
  for ( p= string; *p; ++p, x+= inc )
    draw_tile_s ( fb, fb_width, _char2tile[(unsigned char) *p],
        	  x, y, fgcolor1, fgcolor2, bgcolor, flags );
  
} /* end tiles16b_draw_string_s */


void
init_tiles16b (void)
{
  
  int i;
  
  
  for ( i= 0; i < 256; ++i ) _char2tile[i]= 47; /* Blanc. */
  for ( i= 'A'; i <= 'Z'; ++i ) _char2tile[i]= ((unsigned char) i)-'A';
  for ( i= '0'; i <= '9'; ++i ) _char2tile[i]= ((unsigned char) i)-'0'+26;
  _char2tile['c']= 36; 
  _char2tile['a']= 37;
  _char2tile['e']= 38; /* è */
  _char2tile['r']= 39; /* é */
  _char2tile['i']= 40;
  _char2tile['o']= 41; /* ò */
  _char2tile['p']= 42; /* ó */
  _char2tile['u']= 43;
  _char2tile[':']= 44;
  _char2tile['.']= 45;
  _char2tile['/']= 46;
  _char2tile['-']= 48;
  _char2tile['+']= 49;
  _char2tile['!']= 50;
  
} /* end init_tiles16b */
